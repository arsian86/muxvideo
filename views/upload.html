<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mux video test</title>
    <script src="https://cdn.jsdelivr.net/npm/@mux/mux-uploader"></script>
    <style>
      #uploader {
        display: none;
        margin: 20px auto;
        width: 100%;
        max-width: 600px;
        height: 300px;
        border: 2px dashed #ddd;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Mux Uploader</h1>
    <button id="uploadBtn">é¸æª”ä¸¦ä¸Šå‚³</button>
    <mux-uploader id="uploader"></mux-uploader>

    <script type="module">
      //ç”¢ç”Ÿä¸€æ¬¡æ€§ upload URL
      //è«‹è¨˜å¾—æ›¿æ›ç‚ºæ­£ç¢ºçš„chapterId
      const chapterId = "81b61daa-e16a-4eaf-85a6-5eca84d6f978";
      //æ•™ç·´ç™»å…¥token,è«‹è¨˜å¾—æ›¿æ›ç‚ºæ­£ç¢ºåƒæ•¸
      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjJiY2E3NjQ0LTM4OTktNGUwNi04OWE0LWMzNWY3MzcyODRkMCIsInJvbGUiOiJDT0FDSCIsImlhdCI6MTc0OTIyMDg2MywiZXhwIjoxNzUxODEyODYzfQ._87ce_cG5zjiCzMih5nLWvFqQRlbhSeyx6rQi_7O4PI";
      //æœ¬åœ°æ¸¬è©¦è«‹æ”¹æˆlocalhost:3000,æ­é…ngrokæˆ–å…¶ä»–å·¥å…·æ¥å—webhooké€šçŸ¥
      const API = `https://sportify.zeabur.app/api/v1/coaches/courses/${chapterId}/video/v1/upload`;

      // å–å¾—btn DOM å…ƒä»¶
      const btn = document.getElementById("uploadBtn");
      const uploader = document.getElementById("uploader");
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        btn.textContent = "ç”¢ç”Ÿä¸Šå‚³ç¶²å€â€¦";
        // é»æ“ŠæŒ‰éˆ• â†’ è·‘å®Œæ•´ä¸Šå‚³æµç¨‹
        const resp = await fetch(API, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });
        const data = await resp.json();
        if (!resp.ok || !data.uploadUrl) {
          alert(data.message || "å–å¾—ä¸Šå‚³ç¶²å€å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–å¾Œç«¯æ—¥èªŒ");
          btn.disabled = false;
          btn.textContent = "é¸æª”ä¸¦ä¸Šå‚³";
          return;
        }

        // å›å‚³uploadUrlä¸¦ç™¼é€åˆ°å¾Œç«¯uploadVideo API
        // å°‡ uploadUrl å¥—é€² <mux-uploader>ï¼Œä¸¦é¡¯ç¤ºå…ƒä»¶
        uploader.endpoint = data.uploadUrl;
        uploader.style.display = "block";
        btn.style.display = "none";

        uploader.addEventListener(
          "success",
          () => {
            console.log("ğŸ‰ ä¸Šå‚³çµæŸï¼Œç­‰å¾… webhook é€šçŸ¥ asset.ready");
            btn.style.display = "inline-block";
            btn.textContent = "é‡æ–°ä¸Šå‚³";
            btn.disabled = false;
            uploader.innerHTML = "";
            uploader.style.display = "none";
          },
          { once: true }
        );
      });
    </script>
  </body>
</html>
